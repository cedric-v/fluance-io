---
permalink: /assets/js/payment.js
---
/**
 * Fonctions JavaScript pour gérer les paiements Stripe
 * Utilise Firebase Functions pour créer les sessions Checkout
 */

// Configuration Firebase (même que dans firebase-auth.js)
const firebaseConfig = {
  apiKey: '{{ env.FIREBASE_API_KEY }}',
  authDomain: '{{ env.FIREBASE_AUTH_DOMAIN }}',
  projectId: '{{ env.FIREBASE_PROJECT_ID }}',
  storageBucket: '{{ env.FIREBASE_STORAGE_BUCKET }}',
  messagingSenderId: '{{ env.FIREBASE_MESSAGING_SENDER_ID }}',
  appId: '{{ env.FIREBASE_APP_ID }}',
  measurementId: '{{ env.FIREBASE_MEASUREMENT_ID }}',
};


/**
 * Charge Firebase si pas déjà chargé
 * @returns {Promise} Promise qui se résout quand Firebase est prêt
 */
function loadFirebase() {
  return new Promise((resolve, reject) => {
    // Si Firebase est déjà initialisé
    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
      resolve();
      return;
    }

    // Charger Firebase SDK
    const script1 = document.createElement('script');
    script1.src = 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js';
    document.head.appendChild(script1);

    script1.onload = () => {
      const script2 = document.createElement('script');
      script2.src = 'https://www.gstatic.com/firebasejs/12.8.0/firebase-functions-compat.js';
      document.head.appendChild(script2);

      script2.onload = () => {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        resolve();
      };

      script2.onerror = () => {
        reject(new Error('Erreur lors du chargement de Firebase Functions'));
      };
    };

    script1.onerror = () => {
      reject(new Error('Erreur lors du chargement de Firebase App'));
    };
  });
}

/**
 * Crée une session de paiement Mollie et redirige l'utilisateur
 * @param {string} product - '21jours' ou 'complet'
 * @param {string|null} variant - 'mensuel', 'trimestriel', 'unique', 'abonnement'
 * @param {string} locale - 'fr' ou 'en' (défaut: 'fr')
 * @param {Event} event - Événement de clic (optionnel, pour désactiver le bouton)
 * @param {boolean} includeSosDos - Si true, ajoute le produit cross-sell (Order Bump)
 */
async function redirectToMollieCheckout(product, variant = null, locale = 'fr', event = null, includeSosDos = false) {
  // Récupérer le bouton depuis l'événement ou depuis window.event (fallback)
  const button = event?.target || window.event?.target || null;
  const originalText = button ? button.textContent : null;

  try {
    // Désactiver le bouton et afficher un indicateur de chargement
    if (button) {
      button.disabled = true;
      button.textContent = locale === 'en' ? 'Loading...' : 'Chargement...';
    }

    // Charger Firebase si pas déjà chargé
    await loadFirebase();

    // Obtenir l'instance Firebase Functions
    const app = firebase.app();
    const functions = app.functions('europe-west1');
    const createMollieCheckoutSession = functions.httpsCallable('createMollieCheckoutSession');

    // Préparer les données
    // Récupérer les infos utilisateur depuis le localStorage s'ils existent (Lead magnet)
    /* 
       Note: Nous pourrions demander l'email avant le paiement pour mieux tracker,
       mais pour l'instant nous laissons Mollie gérer ou nous passons null.
       Si vous avez un système de Lead Capture avant, passez les infos ici.
    */
    const storedEmail = localStorage.getItem('user_email');
    const storedFirstName = localStorage.getItem('user_firstname');

    let email = storedEmail;
    let firstName = storedFirstName;
    let lastName = localStorage.getItem('user_lastname');
    // Pour les abonnements et RDV Clarté, l'email/prénom/nom sont obligatoires
    const isRequiredForProduct = (product === 'complet' || product === 'rdv-clarte');
    const isMissingInfo = !email || !firstName || !lastName;

    if (isRequiredForProduct && isMissingInfo) {
      try {
        const userDataCaptured = await showEmailCaptureModal(locale);
        if (!userDataCaptured || !userDataCaptured.email) throw new Error('Email required');
        
        email = userDataCaptured.email;
        firstName = userDataCaptured.firstName;
        lastName = userDataCaptured.lastName;
        
        localStorage.setItem('user_email', email);
        if (firstName) localStorage.setItem('user_firstname', firstName);
        if (lastName) localStorage.setItem('user_lastname', lastName);
      } catch (e) {
        throw new Error('Required info missing for subscription');
      }
    }

    const data = {
      product: product,
      locale: locale,
      includeSosDos: includeSosDos,
      email: email || null,
      firstName: firstName || storedFirstName || null,
      lastName: lastName || null,
      origin: window.location.origin
    };

    // Ajouter variant si nécessaire
    if (variant) {
      data.variant = variant;
    }

    // Appeler la fonction Firebase
    const result = await createMollieCheckoutSession(data);

    if (result.data && result.data.success && result.data.url) {
      // Rediriger vers la page de paiement Mollie
      window.location.href = result.data.url;
    } else {
      throw new Error('Erreur lors de la création de la session de paiement');
    }
  } catch (error) {
    console.error('Erreur lors de la création de la session Mollie:', error);
    const errMsg = error.message || 'Une erreur est survenue. Veuillez réessayer.';
    alert(errMsg);
    
    // Réactiver le bouton en cas d'erreur
    if (button && originalText) {
      button.disabled = false;
      button.textContent = originalText;
    }
  }
}

/**
 * Affiche une modal premium pour capturer l'email (remplace prompt)
 * @param {string} locale - 'fr' ou 'en'
 * @returns {Promise<string>} - L'email capturé
 */
function showEmailCaptureModal(locale = 'fr') {
  return new Promise((resolve) => {
    // Créer l'overlay
    const overlay = document.createElement('div');
    overlay.id = 'email-capture-overlay';
    overlay.style = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; opacity: 0; transition: opacity 0.3s ease;
      font-family: 'Inter', sans-serif;
    `;

    const labels = {
      fr: {
        title: 'Dernière étape avant l\'accès',
        desc: 'Veuillez entrer vos informations pour finaliser votre abonnement et recevoir vos accès.',
        placeholderFirstName: 'Votre prénom',
        placeholderLastName: 'Votre nom',
        placeholderEmail: 'votre@email.com',
        button: 'Continuer vers le paiement',
        error: 'Veuillez remplir tous les champs avec un email valide.'
      },
      en: {
        title: 'One last step',
        desc: 'Please enter your details to finalize your subscription and receive your access.',
        placeholderFirstName: 'Your first name',
        placeholderLastName: 'Your last name',
        placeholderEmail: 'your@email.com',
        button: 'Continue to payment',
        error: 'Please fill all fields and enter a valid email.'
      }
    };

    const t = labels[locale] || labels.fr;

    overlay.innerHTML = `
      <div style="background: white; padding: 2.5rem; border-radius: 1.5rem; max-width: 450px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); text-align: center; position: relative; transform: translateY(20px); transition: transform 0.3s ease;">
        <button id="close-modal" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af;">&times;</button>
        <div style="width: 60px; height: 60px; background: #FEF3C7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
          <svg style="width: 30px; height: 30px; color: #D97706;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
        </div>
        <h3 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 0.75rem;">${t.title}</h3>
        <p style="color: #4b5563; line-height: 1.5; margin-bottom: 2rem;">${t.desc}</p>
        <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
          <input type="text" id="capture-firstname" placeholder="${t.placeholderFirstName}" style="width: 50%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem; outline: none; transition: border-color 0.2s;">
          <input type="text" id="capture-lastname" placeholder="${t.placeholderLastName}" style="width: 50%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem; outline: none; transition: border-color 0.2s;">
        </div>
        <input type="email" id="capture-email" placeholder="${t.placeholderEmail}" style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; margin-bottom: 1rem; font-size: 1rem; outline: none; transition: border-color 0.2s;">
        <p id="email-error" style="color: #ef4444; font-size: 0.875rem; margin-bottom: 1rem; display: none;">${t.error}</p>
        <button id="submit-email" style="width: 100%; background: #E6B84A; color: #7A1F3D; border: none; padding: 1rem; border-radius: 0.75rem; font-weight: 700; font-size: 1rem; cursor: pointer; transition: background 0.2s;">${t.button}</button>
      </div>
    `;

    document.body.appendChild(overlay);

    // Animation entrée
    requestAnimationFrame(() => {
      overlay.style.opacity = '1';
      overlay.querySelector('div').style.transform = 'translateY(0)';
    });

    const inputEmail = overlay.querySelector('#capture-email');
    const inputFirstName = overlay.querySelector('#capture-firstname');
    const inputLastName = overlay.querySelector('#capture-lastname');
    const submitBtn = overlay.querySelector('#submit-email');
    const closeBtn = overlay.querySelector('#close-modal');
    const errorMsg = overlay.querySelector('#email-error');

    inputEmail.value = localStorage.getItem('user_email') || '';
    inputFirstName.value = localStorage.getItem('user_firstname') || '';
    inputLastName.value = localStorage.getItem('user_lastname') || '';

    if (!inputFirstName.value) {
      inputFirstName.focus();
    } else if (!inputLastName.value) {
      inputLastName.focus();
    } else {
      inputEmail.focus();
    }

    function cleanup() {
      overlay.style.opacity = '0';
      overlay.querySelector('div').style.transform = 'translateY(20px)';
      setTimeout(() => {
        if (overlay.parentNode) document.body.removeChild(overlay);
      }, 300);
    }

    submitBtn.onclick = () => {
      const email = inputEmail.value.trim();
      const firstName = inputFirstName.value.trim();
      const lastName = inputLastName.value.trim();
      const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/;
      if (email && emailRegex.test(email) && firstName && lastName) {
        cleanup();
        resolve({ email, firstName, lastName });
      } else {
        if (!firstName) inputFirstName.style.borderColor = '#ef4444';
        if (!lastName) inputLastName.style.borderColor = '#ef4444';
        if (!email || !emailRegex.test(email)) inputEmail.style.borderColor = '#ef4444';
        errorMsg.style.display = 'block';
      }
    };

    inputEmail.onkeypress = (e) => {
      if (e.key === 'Enter') submitBtn.click();
    };

    inputFirstName.onkeypress = (e) => {
      if (e.key === 'Enter') submitBtn.click();
    };

    inputLastName.onkeypress = (e) => {
      if (e.key === 'Enter') submitBtn.click();
    };

    inputEmail.oninput = () => {
      inputEmail.style.borderColor = '#e5e7eb';
      errorMsg.style.display = 'none';
    };

    inputFirstName.oninput = () => {
      inputFirstName.style.borderColor = '#e5e7eb';
      errorMsg.style.display = 'none';
    };

    inputLastName.oninput = () => {
      inputLastName.style.borderColor = '#e5e7eb';
      errorMsg.style.display = 'none';
    };

    closeBtn.onclick = () => {
      cleanup();
      resolve(null);
    };

    overlay.onclick = (e) => {
      if (e.target === overlay) closeBtn.onclick();
    };
  });
}

// Exposer les fonctions globalement pour utilisation dans les pages
window.FluancePayment = {
  redirectToStripe: redirectToMollieCheckout, // Alias pour compatibilité existante
  redirectToMollie: redirectToMollieCheckout,
};

// Fonctions de compatibilité (pour utilisation directe dans onclick)
window.redirectToStripeCheckout = redirectToMollieCheckout;


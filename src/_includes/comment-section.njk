{# 
  Section de commentaires pour les vidéos du programme 21 jours
  Usage: {% commentSection %}
#}
<div class="mt-8 pt-8 border-t border-gray-200">
  <h3 class="text-xl font-semibold text-[#0f172a] mb-4">
    Quelles améliorations avez-vous ressenties suite à la pratique du jour ?
  </h3>
  
  <!-- Comment Section -->
  <form id="comment-form" class="mb-6 space-y-4">
    <input 
      type="text" 
      id="name" 
      placeholder="Votre prénom" 
      required 
      class="w-full px-4 py-2 border border-fluance/20 rounded-lg focus:ring-2 focus:ring-fluance focus:border-fluance text-[#0f172a]"
    />
    <textarea 
      id="text" 
      placeholder="Votre commentaire" 
      required
      rows="4"
      class="w-full px-4 py-2 border border-fluance/20 rounded-lg focus:ring-2 focus:ring-fluance focus:border-fluance text-[#0f172a]"
    ></textarea>
    <button 
      type="submit"
      class="bg-fluance text-white py-2 px-6 rounded-lg font-semibold hover:bg-fluance/90 transition-colors duration-200"
    >
      Envoyer
    </button>
  </form>
  
  <div id="comments-container" class="mb-4"></div>
  <div id="pagination-controls" class="mt-4"></div>
</div>

<!-- Firebase App + Firestore (utilise le projet principal fluance-protected-content) -->
<!-- Les scripts Firebase sont déjà chargés par firebase-auth.js -->

<!-- Fonctions utilitaires -->
<script>
function decodeHTML(str) {
  if (!str) return '';
  // Décoder récursivement pour gérer le double encodage
  var textarea = document.createElement('textarea');
  var decoded = str;
  var previous = '';
  // Décoder jusqu'à ce qu'il n'y ait plus de changement (max 5 itérations pour éviter les boucles infinies)
  for (var i = 0; i < 5 && decoded !== previous; i++) {
    previous = decoded;
    textarea.innerHTML = decoded;
    decoded = textarea.value;
  }
  return decoded;
}
function escapeHTML(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}
</script>

<!-- Script principal -->
<script>
(function() {
  // Utiliser le même projet Firebase que le reste du site (fluance-protected-content)
  // Firebase est déjà initialisé par firebase-auth.js
  if (typeof firebase === 'undefined' || !firebase.apps.length) {
    console.error('Firebase n\'est pas initialisé. Assurez-vous que firebase-auth.js est chargé avant ce script.');
    return;
  }
  
  var db = firebase.firestore();
  var pageId = encodeURIComponent(window.location.origin + window.location.pathname);
  var COMMENTS_PER_PAGE = 20;
  var allComments = [];
  var currentPage = 1;

  // Gérer la soumission du formulaire
  var commentForm = document.getElementById("comment-form");
  if (commentForm) {
    commentForm.addEventListener("submit", function (e) {
      e.preventDefault();
      var name = document.getElementById("name").value.trim();
      var text = document.getElementById("text").value.trim();
      
      if (!name || !text) return;
      
      if (/[<>]/.test(name) || /[<>]/.test(text)) {
        alert("Les caractères < et > ne sont pas autorisés.");
        return;
      }
      
      db.collection("comments").doc(pageId).collection("messages").add({
        name: name,
        text: text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(function() {
        document.getElementById("comment-form").reset();
      }).catch(function(error) {
        console.error("Erreur lors de l'ajout du commentaire:", error);
        alert("Erreur lors de l'envoi du commentaire. Veuillez réessayer.");
      });
    });
  }

  function renderCommentsPage(page) {
    var container = document.getElementById("comments-container");
    if (!container) return;
    
    container.innerHTML = "<h4 class='text-lg font-semibold text-[#0f172a] mb-4'>Commentaires</h4>";
    
    if (allComments.length === 0) {
      container.innerHTML += "<p class='text-[#1f1f1f]/60 text-sm'>Aucun commentaire pour le moment. Soyez le premier à partager votre expérience !</p>";
      renderPaginationControls(page);
      return;
    }
    
    var start = (page - 1) * COMMENTS_PER_PAGE;
    var end = start + COMMENTS_PER_PAGE;
    var pageComments = allComments.slice(start, end);
    
    for (var i = 0; i < pageComments.length; i++) {
      var c = pageComments[i];
      // Décoder d'abord les entités HTML existantes, puis échapper pour sécurité
      var decodedText = decodeHTML(c.text);
      var decodedName = decodeHTML(c.name);
      var text = escapeHTML(decodedText);
      var name = escapeHTML(decodedName);
      
      container.innerHTML += '<div class="border-b border-gray-200 mb-4 pb-4"><div class="mb-2"><strong class="text-[#0f172a]">' + name + '</strong></div><p class="text-[#1f1f1f]/80">' + text + '</p></div>';
    }
    
    renderPaginationControls(page);
  }

  function renderPaginationControls(page) {
    var controls = document.getElementById("pagination-controls");
    if (!controls) return;
    
    var totalPages = Math.ceil(allComments.length / COMMENTS_PER_PAGE);
    
    if (totalPages <= 1) {
      controls.innerHTML = '';
      return;
    }
    
    // Vider le conteneur
    controls.innerHTML = '';
    
    // Bouton précédent
    if (page > 1) {
      var prevBtn = document.createElement('button');
      prevBtn.id = 'prev-page';
      prevBtn.textContent = '< Précédent';
      prevBtn.style.cursor = 'pointer';
      prevBtn.style.padding = '0.5rem 1rem';
      prevBtn.style.borderRadius = '0.5rem';
      prevBtn.style.border = '1px solid rgba(130, 21, 62, 0.2)';
      prevBtn.style.backgroundColor = 'transparent';
      prevBtn.style.color = '#82153e';
      prevBtn.style.fontWeight = '500';
      prevBtn.style.transition = 'all 0.2s ease';
      prevBtn.style.marginRight = '0.5rem';
      prevBtn.onmouseenter = function() {
        this.style.backgroundColor = 'rgba(130, 21, 62, 0.1)';
        this.style.borderColor = 'rgba(130, 21, 62, 0.3)';
        this.style.transform = 'translateY(-1px)';
      };
      prevBtn.onmouseleave = function() {
        this.style.backgroundColor = 'transparent';
        this.style.borderColor = 'rgba(130, 21, 62, 0.2)';
        this.style.transform = 'translateY(0)';
      };
      prevBtn.onclick = function() {
        currentPage--;
        renderCommentsPage(currentPage);
      };
      controls.appendChild(prevBtn);
      controls.appendChild(document.createTextNode(' '));
    }
    
    // Texte de pagination
    var pageText = document.createElement('span');
    pageText.style.color = 'rgba(31, 31, 31, 0.8)';
    pageText.style.fontSize = '0.875rem';
    pageText.textContent = 'Page ' + page + ' / ' + totalPages;
    controls.appendChild(pageText);
    
    // Bouton suivant
    if (page < totalPages) {
      controls.appendChild(document.createTextNode(' '));
      var nextBtn = document.createElement('button');
      nextBtn.id = 'next-page';
      nextBtn.textContent = 'Suivant >';
      nextBtn.style.cursor = 'pointer';
      nextBtn.style.padding = '0.5rem 1rem';
      nextBtn.style.borderRadius = '0.5rem';
      nextBtn.style.border = '1px solid rgba(130, 21, 62, 0.2)';
      nextBtn.style.backgroundColor = 'transparent';
      nextBtn.style.color = '#82153e';
      nextBtn.style.fontWeight = '500';
      nextBtn.style.transition = 'all 0.2s ease';
      nextBtn.style.marginLeft = '0.5rem';
      nextBtn.onmouseenter = function() {
        this.style.backgroundColor = 'rgba(130, 21, 62, 0.1)';
        this.style.borderColor = 'rgba(130, 21, 62, 0.3)';
        this.style.transform = 'translateY(-1px)';
      };
      nextBtn.onmouseleave = function() {
        this.style.backgroundColor = 'transparent';
        this.style.borderColor = 'rgba(130, 21, 62, 0.2)';
        this.style.transform = 'translateY(0)';
      };
      nextBtn.onclick = function() {
        currentPage++;
        renderCommentsPage(currentPage);
      };
      controls.appendChild(nextBtn);
    }
  }

  // Charger les commentaires
  if (db && pageId) {
    db.collection("comments").doc(pageId).collection("messages")
      .orderBy("timestamp", "desc")
      .onSnapshot(function(snapshot) {
        allComments = [];
        snapshot.forEach(function(doc) {
          allComments.push(doc.data());
        });
        
        // Trier par date (plus récent en premier)
        allComments.sort(function(a, b) {
          if (a.timestamp && b.timestamp) {
            try {
              var timeA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
              var timeB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
              return timeB - timeA;
            } catch (e) {
              return 0;
            }
          }
          return 0;
        });
        
        currentPage = 1;
        renderCommentsPage(currentPage);
      }, function(error) {
        console.error("Erreur Firestore :", error);
        var container = document.getElementById("comments-container");
        if (container) {
          container.innerHTML = "<p class='text-red-600 text-sm'>Erreur lors du chargement des commentaires.</p>";
        }
      });
  }
})();
</script>


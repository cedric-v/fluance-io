<!-- Pop-up personnalisée pour inscription newsletter -->
<div id="newsletter-popup" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.5);">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 md:p-8 relative">
    <button id="close-popup" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl leading-none" aria-label="Fermer">&times;</button>
    
    <h2 class="text-2xl md:text-3xl font-semibold text-[#3E3A35] mb-2">Recevez 2 pratiques Fluance</h2>
    <p class="text-gray-600 mb-6">Il suffit de remplir le formulaire ci-dessous :</p>
    
    <form id="newsletter-form" class="space-y-4" autocomplete="off" data-form-type="newsletter" data-1p-ignore="true" data-lastpass-ignore="true">
      <div>
        <label for="newsletter-name" class="block text-sm font-medium text-gray-700 mb-2">Prénom <span class="text-red-500">*</span></label>
        <input type="text" id="newsletter-name" name="newsletter-name" required autocomplete="given-name" data-lpignore="true" data-1p-ignore="true" data-lastpass-ignore="true" data-form-type="other" data-bwignore="true" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#5B8A8F] focus:border-transparent">
      </div>
      
      <div>
        <label for="newsletter-email" class="block text-sm font-medium text-gray-700 mb-2">Email <span class="text-red-500">*</span></label>
        <input type="email" id="newsletter-email" name="newsletter-email" required autocomplete="email" data-lpignore="true" data-1p-ignore="true" data-lastpass-ignore="true" data-form-type="other" data-bwignore="true" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#5B8A8F] focus:border-transparent">
      </div>
      
      <div id="form-message" class="hidden text-sm"></div>
      
      <!-- Cloudflare Turnstile -->
      <!-- Utilise la clé de test en développement local, la clé de production en production -->
      <!-- Note: Le site n'a pas besoin d'être sur Cloudflare pour utiliser Turnstile -->
      <div class="cf-turnstile" 
           data-sitekey="0x4AAAAAACF5HWhHHcGA5yJk" 
           data-theme="light" 
           data-size="normal" 
           data-callback="onTurnstileSuccess"
           data-error-callback="onTurnstileError"
           id="turnstile-widget"
           style="display: none;"
           aria-label="Vérification anti-bot Cloudflare Turnstile"
           role="region"></div>
      <!-- Message d'aide si Turnstile ne se charge pas -->
      <div id="turnstile-loading-message" class="text-sm text-gray-600 mb-2" style="display: none;">
        <span class="inline-block animate-spin mr-2">⏳</span>
        Chargement de la vérification anti-bot...
      </div>
      <div id="turnstile-error-message" class="text-sm text-yellow-600 mb-2 hidden">
        ⚠️ La vérification anti-bot ne se charge pas. <strong>Vous pouvez quand même vous inscrire en cliquant sur le bouton ci-dessous</strong>. Vous devrez confirmer votre email.
      </div>
      
      <button type="submit" id="submit-btn" class="w-full btn-primary !text-[#7A1F3D] bg-[#E6B84A] hover:bg-[#E8C15A] py-3 px-6 rounded-md font-medium transition-colors">
        <span id="submit-text">Recevoir immédiatement</span>
        <span id="submit-loading" class="hidden">Envoi en cours...</span>
      </button>
      
      <div class="text-xs text-gray-500 mt-4">
        En soumettant ce formulaire, j'accepte que mes informations soient utilisées dans le cadre de ma demande et de la relation commerciale éthique et personnalisée qui peut en découler. Pour connaître et exercer mes droits, notamment pour annuler mon consentement, je consulte les <a href="/mentions-legales" class="text-[#5B8A8F] hover:underline" target="_blank">mentions légales et la politique de confidentialité</a>.
      </div>
    </form>
  </div>
</div>

<script>
  // Pop-up newsletter personnalisée avec Firebase Functions
  document.addEventListener('DOMContentLoaded', function() {
    const popup = document.getElementById('newsletter-popup');
    if (!popup) return; // Si la pop-up n'existe pas, ne pas initialiser
    
    const closeBtn = document.getElementById('close-popup');
    const form = document.getElementById('newsletter-form');
    const messageDiv = document.getElementById('form-message');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');
    const turnstileWidget = document.getElementById('turnstile-widget');
    
    // Détecter si on est en développement local
    const isLocalhost = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1' ||
                       window.location.hostname.startsWith('192.168.') ||
                       window.location.hostname.startsWith('10.') ||
                       window.location.hostname.endsWith('.local');
    
    // Callbacks Turnstile
    window.onTurnstileSuccess = function(token) {
      console.log('Turnstile verification successful');
    };
    
    window.onTurnstileError = function(error) {
      console.error('Turnstile error:', error);
      // En cas d'erreur, on peut toujours permettre la soumission en localhost
      if (isLocalhost) {
        console.warn('Turnstile error in localhost, allowing submission anyway');
      }
    };
    
    // Configurer Turnstile selon l'environnement
    const loadingMessage = document.getElementById('turnstile-loading-message');
    const errorMessage = document.getElementById('turnstile-error-message');
    let turnstileFailed = false; // Flag pour indiquer si Turnstile a échoué
    let turnstileTimeout = null;
    
    if (turnstileWidget && !isLocalhost) {
      // Afficher le message de chargement
      if (loadingMessage) loadingMessage.style.display = 'block';
      
      // Timeout : si Turnstile ne se charge pas après 3 secondes, permettre le fallback
      turnstileTimeout = setTimeout(() => {
        const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]');
        if (!turnstileResponse || !turnstileResponse.value) {
          // Turnstile n'a pas réussi à se charger
          turnstileFailed = true;
          if (loadingMessage) loadingMessage.style.display = 'none';
          if (errorMessage) {
            errorMessage.classList.remove('hidden');
            errorMessage.innerHTML = '⚠️ La vérification anti-bot ne se charge pas. <strong>Vous pouvez quand même vous inscrire en cliquant sur le bouton ci-dessous</strong>. Vous devrez confirmer votre email.';
            errorMessage.className = 'text-sm text-yellow-600 mb-2';
          }
          if (turnstileWidget) turnstileWidget.style.display = 'none';
          console.warn('[Turnstile] Widget failed to load, fallback mode enabled');
        }
      }, 3000); // 3 secondes de timeout (réduit pour une meilleure UX)
      
      // Attendre que le script Turnstile soit chargé
      function initTurnstile() {
        if (typeof turnstile === 'undefined') {
          // Le script Turnstile n'est pas encore chargé, réessayer
          setTimeout(initTurnstile, 100);
          return;
        }
        
        // Le script est chargé, annuler le timeout
        if (turnstileTimeout) {
          clearTimeout(turnstileTimeout);
          turnstileTimeout = null;
        }
        
        // Le script est chargé, configurer le widget
        if (isLocalhost) {
          // En développement local, utiliser la clé de test Cloudflare
          turnstileWidget.setAttribute('data-sitekey', '0x4AAAAAAABkMYinukE8K9X0');
        } else {
          // En production, utiliser la clé de production
          turnstileWidget.setAttribute('data-sitekey', '0x4AAAAAACF5HWhHHcGA5yJk');
        }
        
        // Afficher le widget
        turnstileWidget.style.display = 'block';
        if (loadingMessage) loadingMessage.style.display = 'none';
        if (errorMessage) errorMessage.classList.add('hidden');
        
        // Vérifier après 2 secondes supplémentaires si le widget s'est bien initialisé
        setTimeout(() => {
          const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]');
          if (!turnstileResponse && !isLocalhost) {
            // Le widget ne s'est pas initialisé correctement
            turnstileFailed = true;
            if (loadingMessage) loadingMessage.style.display = 'none';
            if (errorMessage) {
              errorMessage.classList.remove('hidden');
              errorMessage.innerHTML = '⚠️ La vérification anti-bot ne se charge pas. <strong>Vous pouvez quand même vous inscrire en cliquant sur le bouton ci-dessous</strong>. Vous devrez confirmer votre email.';
              errorMessage.className = 'text-sm text-yellow-600 mb-2';
            }
            if (turnstileWidget) turnstileWidget.style.display = 'none';
            console.warn('[Turnstile] Widget failed to initialize, fallback mode enabled');
          }
        }, 2000);
      }
      
      // Démarrer l'initialisation
      initTurnstile();
    } else if (isLocalhost) {
      // En localhost, pas besoin de Turnstile
      if (turnstileWidget) turnstileWidget.style.display = 'none';
      if (loadingMessage) loadingMessage.style.display = 'none';
      if (errorMessage) errorMessage.classList.add('hidden');
    }
    
    // Fonction pour charger Firebase et Firebase Functions
    async function loadFirebaseFunctions() {
      return new Promise((resolve, reject) => {
        // Configuration Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyDJ-VlDMC5PUEMeILLZ8OmdYIhvhxIfhdM",
          authDomain: "fluance-protected-content.firebaseapp.com",
          projectId: "fluance-protected-content",
          storageBucket: "fluance-protected-content.firebasestorage.app",
          messagingSenderId: "173938686776",
          appId: "1:173938686776:web:891caf76098a42c3579fcd",
          measurementId: "G-CWPNXDQEYR"
        };
        
        // Vérifier si Firebase est déjà chargé et initialisé
        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
          // Firebase est déjà initialisé, charger Functions si nécessaire
          if (firebase.functions) {
            resolve();
          } else {
            loadFunctionsModule(resolve, reject);
          }
          return;
        }
        
        // Charger Firebase de manière séquentielle (app-compat d'abord, puis functions-compat)
        const appScriptUrl = 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js';
        const functionsScriptUrl = 'https://www.gstatic.com/firebasejs/12.6.0/firebase-functions-compat.js';
        
        // Vérifier si app-compat est déjà chargé
        if (document.querySelector(`script[src="${appScriptUrl}"]`)) {
          // App est déjà chargé, vérifier si initialisé
          if (typeof firebase !== 'undefined') {
            if (!firebase.apps.length) {
              firebase.initializeApp(firebaseConfig);
            }
            // Charger Functions
            loadFunctionsScript();
          } else {
            // Attendre que firebase soit disponible
            waitForFirebase();
          }
        } else {
          // Charger app-compat d'abord
          const appScript = document.createElement('script');
          appScript.src = appScriptUrl;
          appScript.onload = () => {
            // Attendre un peu pour que le module soit prêt
            setTimeout(() => {
              if (typeof firebase === 'undefined') {
                reject(new Error('Firebase App n\'a pas pu être chargé'));
                return;
              }
              
              // Initialiser Firebase
              if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
              }
              
              // Maintenant charger Functions
              loadFunctionsScript();
            }, 100);
          };
          appScript.onerror = () => reject(new Error('Erreur lors du chargement de Firebase App'));
          document.head.appendChild(appScript);
        }
        
        function loadFunctionsScript() {
          // Vérifier si functions-compat est déjà chargé
          if (document.querySelector(`script[src="${functionsScriptUrl}"]`)) {
            // Functions est déjà chargé, vérifier qu'il est disponible
            loadFunctionsModule(resolve, reject);
          } else {
            // Charger functions-compat
            const functionsScript = document.createElement('script');
            functionsScript.src = functionsScriptUrl;
            functionsScript.onload = () => {
              // Attendre que Functions soit disponible
              loadFunctionsModule(resolve, reject);
            };
            functionsScript.onerror = () => reject(new Error('Erreur lors du chargement de Firebase Functions'));
            document.head.appendChild(functionsScript);
          }
        }
        
        function waitForFirebase() {
          let attempts = 0;
          const checkFirebase = setInterval(() => {
            attempts++;
            if (typeof firebase !== 'undefined') {
              clearInterval(checkFirebase);
              if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
              }
              loadFunctionsScript();
            } else if (attempts > 50) {
              clearInterval(checkFirebase);
              reject(new Error('Timeout: Firebase n\'a pas pu être chargé'));
            }
          }, 100);
        }
        
        function loadFunctionsModule(resolve, reject) {
          let attempts = 0;
          const checkFunctions = setInterval(() => {
            attempts++;
            if (firebase.functions) {
              clearInterval(checkFunctions);
              resolve();
            } else if (attempts > 50) { // 5 secondes max
              clearInterval(checkFunctions);
              reject(new Error('Firebase Functions n\'a pas pu être initialisé'));
            }
          }, 100);
        }
      });
    }
    
    // Ouvrir la pop-up au clic sur les boutons
    const buttons = document.querySelectorAll('[data-w-token="9241cb136525ee5e376e"]');
    buttons.forEach(function(button) {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        popup.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Empêcher le scroll
      });
    });
    
    // Fermer la pop-up
    function closePopup() {
      popup.classList.add('hidden');
      document.body.style.overflow = ''; // Rétablir le scroll
      if (form) form.reset();
      if (messageDiv) messageDiv.classList.add('hidden');
      // Réinitialiser Turnstile
      if (window.turnstile) {
        const widget = document.getElementById('turnstile-widget');
        if (widget) {
          window.turnstile.reset();
        }
      }
    }
    
    if (closeBtn) closeBtn.addEventListener('click', closePopup);
    popup.addEventListener('click', function(e) {
      if (e.target === popup) {
        closePopup();
      }
    });
    
    // Soumettre le formulaire
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('newsletter-email').value.trim();
        const name = document.getElementById('newsletter-name').value.trim();
        
        if (!name) {
          showMessage('Veuillez entrer votre prénom', 'error');
          return;
        }
        
        if (!email) {
          showMessage('Veuillez entrer votre email', 'error');
          return;
        }
        
        // Validation du format de l'email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showMessage('Veuillez entrer une adresse email valide', 'error');
          return;
        }
        
        // Vérifier que Turnstile est complété (seulement si pas en localhost)
        let turnstileToken = null;
        let turnstileSkipped = false;
        
        if (!isLocalhost) {
          const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]');
          if (!turnstileResponse || !turnstileResponse.value) {
            // Si Turnstile a échoué à se charger (fallback activé), permettre la soumission
            if (turnstileFailed) {
              turnstileSkipped = true;
              console.log('[Form] Submitting without Turnstile (fallback mode)');
              // Afficher un message informatif mais ne pas bloquer
              if (messageDiv) {
                messageDiv.textContent = '⚠️ Inscription en cours sans vérification anti-bot. Vous devrez confirmer votre email.';
                messageDiv.className = 'text-sm text-yellow-600';
                messageDiv.classList.remove('hidden');
              }
            } else {
              // Turnstile devrait être disponible mais n'est pas complété
              // Vérifier si le script Turnstile s'est chargé du tout
              if (typeof turnstile === 'undefined') {
                // Le script ne s'est jamais chargé, activer le fallback automatiquement
                turnstileFailed = true;
                turnstileSkipped = true;
                console.log('[Form] Turnstile script never loaded, enabling fallback automatically');
                // Ne pas bloquer, continuer avec le fallback
              } else {
                // Le script est chargé mais le widget n'est pas complété
                const widgetVisible = turnstileWidget && turnstileWidget.style.display !== 'none';
                if (!widgetVisible) {
                  // Le widget n'est pas visible, activer le fallback
                  turnstileFailed = true;
                  turnstileSkipped = true;
                  console.log('[Form] Turnstile widget not visible, enabling fallback automatically');
                  // Ne pas bloquer, continuer avec le fallback
                } else {
                  // Le widget est visible mais pas complété
                  showMessage('Veuillez compléter la vérification anti-bot ci-dessus', 'error');
                  return;
                }
              }
            }
          } else {
            turnstileToken = turnstileResponse.value;
          }
        }
        
        // Désactiver le bouton et afficher le loading
        if (submitBtn) submitBtn.disabled = true;
        if (submitText) submitText.classList.add('hidden');
        if (submitLoading) submitLoading.classList.remove('hidden');
        if (messageDiv) messageDiv.classList.add('hidden');
        
        try {
          // Charger Firebase Functions
          await loadFirebaseFunctions();
          
          // Vérifier que Firebase est complètement initialisé
          if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
            throw new Error('Firebase n\'est pas initialisé');
          }
          
          if (!firebase.functions) {
            throw new Error('Firebase Functions n\'est pas disponible');
          }
          
          // Appeler la fonction Firebase
          const app = firebase.app();
          if (!app) {
            throw new Error('Impossible d\'obtenir l\'instance Firebase');
          }
          
          const functions = app.functions('europe-west1');
          const subscribeToNewsletter = functions.httpsCallable('subscribeToNewsletter');
          const result = await subscribeToNewsletter({ 
            email: email, 
            name: name, 
            turnstileToken: turnstileToken,
            isLocalhost: isLocalhost, // Informer le serveur si on est en localhost
            turnstileSkipped: turnstileSkipped // Informer le serveur si Turnstile a été ignoré (fallback)
          });
          
          if (result.data && result.data.success) {
            const successMessage = turnstileSkipped 
              ? 'Merci ! Un email de confirmation vous a été envoyé. Veuillez cliquer sur le lien dans l\'email pour confirmer votre inscription. Pensez à vérifier vos spams / courriers indésirables. (Inscription effectuée sans vérification anti-bot)'
              : 'Merci ! Un email de confirmation vous a été envoyé. Veuillez cliquer sur le lien dans l\'email pour confirmer votre inscription. Pensez à vérifier vos spams / courriers indésirables.';
            showMessage(successMessage, 'success');
            // Rediriger vers la page 2-pratiques-offertes après 3 secondes
            setTimeout(() => {
              window.location.href = '/2-pratiques-offertes/';
            }, 3000);
          } else {
            showMessage('Une erreur est survenue. Veuillez réessayer.', 'error');
          }
        } catch (error) {
          console.error('Erreur lors de l\'inscription:', error);
          
          // Gérer les erreurs spécifiques
          let errorMessage = 'Une erreur est survenue. Veuillez réessayer.';
          
          if (error.code === 'functions/not-found') {
            errorMessage = 'La fonction n\'est pas encore déployée. Veuillez déployer la fonction subscribeToNewsletter.';
          } else if (error.code === 'functions/unavailable') {
            errorMessage = 'Le service est temporairement indisponible. Veuillez réessayer plus tard.';
          } else if (error.message) {
            errorMessage = error.message;
          } else if (error.code) {
            errorMessage = `Erreur: ${error.code}`;
          }
          
          showMessage(errorMessage, 'error');
        } finally {
          // Réactiver le bouton
          if (submitBtn) submitBtn.disabled = false;
          if (submitText) submitText.classList.remove('hidden');
          if (submitLoading) submitLoading.classList.add('hidden');
        }
      });
    }
    
    function showMessage(text, type) {
      if (messageDiv) {
        messageDiv.textContent = text;
        messageDiv.className = 'text-sm ' + (type === 'success' ? 'text-green-600' : 'text-red-600');
        messageDiv.classList.remove('hidden');
      }
    }
  });
</script>

<!-- Cloudflare Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

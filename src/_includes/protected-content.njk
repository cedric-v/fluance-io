{# 
  Shortcode pour afficher du contenu protégé
  Usage: {% protectedContent "content-id" %}
#}
<div class="protected-content" data-content-id="{{ contentId }}">
  <div class="bg-gray-100 rounded-lg p-8 text-center">
    <p class="text-gray-600 mb-4">Chargement du contenu protégé...</p>
    <div class="animate-pulse">
      <div class="h-4 bg-gray-300 rounded w-3/4 mx-auto mb-2"></div>
      <div class="h-4 bg-gray-300 rounded w-1/2 mx-auto"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  // Attendre que Firebase soit complètement initialisé
  await new Promise((resolve) => {
    if (typeof window.FluanceAuth !== 'undefined' && 
        typeof firebase !== 'undefined' && 
        firebase.apps.length > 0) {
      resolve();
    } else {
      const checkInterval = setInterval(() => {
        if (typeof window.FluanceAuth !== 'undefined' && 
            typeof firebase !== 'undefined' && 
            firebase.apps.length > 0) {
          clearInterval(checkInterval);
          resolve();
        }
      }, 100);
      // Timeout de sécurité après 5 secondes
      setTimeout(() => {
        clearInterval(checkInterval);
        resolve();
      }, 5000);
    }
  });
  
  const protectedContentElements = document.querySelectorAll('.protected-content[data-content-id]');
  
  // Fonction pour charger le contenu protégé
  async function loadProtectedContentForElement(element) {
    const contentId = element.getAttribute('data-content-id');
    
    // Attendre que l'état d'authentification soit synchronisé
    // Utiliser onAuthStateChanged pour être sûr que l'état est à jour
    await new Promise((resolve) => {
      if (typeof firebase !== 'undefined' && firebase.auth) {
        // Vérifier immédiatement
        const currentUser = firebase.auth().currentUser;
        if (currentUser) {
          resolve();
          return;
        }
        
        // Sinon, attendre le prochain changement d'état
        const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
          unsubscribe();
          resolve();
        });
        
        // Timeout de sécurité
        setTimeout(() => {
          unsubscribe();
          resolve();
        }, 2000);
      } else {
        resolve();
      }
    });
    
    // Vérifier si l'utilisateur est authentifié
    const isAuth = window.FluanceAuth && window.FluanceAuth.isAuthenticated();
    
    if (isAuth) {
      // Charger et afficher le contenu
      await window.FluanceAuth.displayProtectedContent(contentId, element);
    } else {
      // Afficher un message de connexion
      element.innerHTML = `
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
          <p class="text-yellow-800 mb-4">Veuillez vous connecter pour accéder à ce contenu.</p>
          <a href="/connexion-firebase?return=${encodeURIComponent(window.location.pathname)}" class="inline-block bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
            Se connecter
          </a>
        </div>
      `;
    }
  }
  
  // Charger le contenu pour chaque élément
  protectedContentElements.forEach(async (element) => {
    await loadProtectedContentForElement(element);
  });
});
</script>




<!-- Pop-up personnalisée pour inscription 5 jours -->
<div id="newsletter-popup-5jours" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.5);">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 md:p-8 relative">
    <button id="close-popup-5jours" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl leading-none" aria-label="Fermer">&times;</button>
    
    <h2 class="text-2xl md:text-3xl font-semibold text-[#3E3A35] mb-2">Recevez vos 5 pratiques Fluance</h2>
    <p class="text-gray-600 mb-6">Il suffit de remplir le formulaire ci-dessous :</p>
    
    <form id="newsletter-form-5jours" class="space-y-4" autocomplete="off" data-form-type="newsletter" data-1p-ignore="true" data-lastpass-ignore="true">
      <div>
        <label for="newsletter-name-5jours" class="block text-sm font-medium text-gray-700 mb-2">Prénom <span class="text-red-500">*</span></label>
        <input type="text" id="newsletter-name-5jours" name="newsletter-name-5jours" required autocomplete="given-name" data-lpignore="true" data-1p-ignore="true" data-lastpass-ignore="true" data-form-type="other" data-bwignore="true" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#5B8A8F] focus:border-transparent">
      </div>
      
      <div>
        <label for="newsletter-email-5jours" class="block text-sm font-medium text-gray-700 mb-2">Email <span class="text-red-500">*</span></label>
        <input type="email" id="newsletter-email-5jours" name="newsletter-email-5jours" required autocomplete="email" data-lpignore="true" data-1p-ignore="true" data-lastpass-ignore="true" data-form-type="other" data-bwignore="true" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#5B8A8F] focus:border-transparent">
      </div>
      
      <div id="form-message-5jours" class="hidden text-sm"></div>
      
      <!-- Cloudflare Turnstile -->
      <div class="cf-turnstile" 
           data-sitekey="0x4AAAAAACF5HWhHHcGA5yJk" 
           data-theme="light" 
           data-size="normal" 
           data-callback="onTurnstileSuccess5jours"
           data-error-callback="onTurnstileError5jours"
           id="turnstile-widget-5jours"
           style="display: none;"></div>
      
      <button type="submit" id="submit-btn-5jours" class="w-full btn-primary !text-[#7A1F3D] bg-[#E6B84A] hover:bg-[#E8C15A] py-3 px-6 rounded-md font-medium transition-colors">
        <span id="submit-text-5jours">Recevoir immédiatement</span>
        <span id="submit-loading-5jours" class="hidden">Envoi en cours...</span>
      </button>
      
      <div class="text-xs text-gray-500 mt-4">
        En soumettant ce formulaire, j'accepte que mes informations soient utilisées dans le cadre de ma demande et de la relation commerciale éthique et personnalisée qui peut en découler. Pour connaître et exercer mes droits, notamment pour annuler mon consentement, je consulte les <a href="/mentions-legales" class="text-[#5B8A8F] hover:underline" target="_blank">mentions légales et la politique de confidentialité</a>.
      </div>
    </form>
  </div>
</div>

<script>
  // Pop-up newsletter 5 jours avec Firebase Functions
  document.addEventListener('DOMContentLoaded', function() {
    const popup = document.getElementById('newsletter-popup-5jours');
    if (!popup) return;
    
    const closeBtn = document.getElementById('close-popup-5jours');
    const form = document.getElementById('newsletter-form-5jours');
    const messageDiv = document.getElementById('form-message-5jours');
    const submitBtn = document.getElementById('submit-btn-5jours');
    const submitText = document.getElementById('submit-text-5jours');
    const submitLoading = document.getElementById('submit-loading-5jours');
    const turnstileWidget = document.getElementById('turnstile-widget-5jours');
    
    // Détecter si on est en développement local
    const isLocalhost = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1' ||
                       window.location.hostname.startsWith('192.168.') ||
                       window.location.hostname.startsWith('10.') ||
                       window.location.hostname.endsWith('.local');
    
    // Callbacks Turnstile
    window.onTurnstileSuccess5jours = function(token) {
      console.log('Turnstile verification successful (5 jours)');
    };
    
    window.onTurnstileError5jours = function(error) {
      console.error('Turnstile error (5 jours):', error);
    };
    
    // Configurer Turnstile selon l'environnement
    if (turnstileWidget) {
      if (isLocalhost) {
        turnstileWidget.setAttribute('data-sitekey', '0x4AAAAAAABkMYinukE8K9X0');
        turnstileWidget.style.display = 'block';
      } else {
        turnstileWidget.setAttribute('data-sitekey', '0x4AAAAAACF5HWhHHcGA5yJk');
        turnstileWidget.style.display = 'block';
      }
    }
    
    // Fonction pour charger Firebase et Firebase Functions
    async function loadFirebaseFunctions() {
      return new Promise((resolve, reject) => {
        const firebaseConfig = {
          apiKey: "AIzaSyDJ-VlDMC5PUEMeILLZ8OmdYIhvhxIfhdM",
          authDomain: "fluance-protected-content.firebaseapp.com",
          projectId: "fluance-protected-content",
          storageBucket: "fluance-protected-content.firebasestorage.app",
          messagingSenderId: "173938686776",
          appId: "1:173938686776:web:891caf76098a42c3579fcd",
          measurementId: "G-CWPNXDQEYR"
        };

        if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
          if (firebase.functions) {
            resolve();
          } else {
            loadFunctionsModule(resolve, reject);
          }
          return;
        }

        const appScriptUrl = 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js';
        const functionsScriptUrl = 'https://www.gstatic.com/firebasejs/12.6.0/firebase-functions-compat.js';

        if (document.querySelector(`script[src="${appScriptUrl}"]`)) {
          if (typeof firebase !== 'undefined') {
            if (!firebase.apps.length) {
              firebase.initializeApp(firebaseConfig);
            }
            loadFunctionsScript();
          } else {
            waitForFirebase();
          }
        } else {
          const appScript = document.createElement('script');
          appScript.src = appScriptUrl;
          appScript.onload = () => {
            setTimeout(() => {
              if (typeof firebase === 'undefined') {
                reject(new Error('Firebase App n\'a pas pu être chargé'));
                return;
              }
              if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
              }
              loadFunctionsScript();
            }, 100);
          };
          appScript.onerror = () => reject(new Error('Erreur lors du chargement de Firebase App'));
          document.head.appendChild(appScript);
        }

        function loadFunctionsScript() {
          if (document.querySelector(`script[src="${functionsScriptUrl}"]`)) {
            loadFunctionsModule(resolve, reject);
          } else {
            const functionsScript = document.createElement('script');
            functionsScript.src = functionsScriptUrl;
            functionsScript.onload = () => {
              loadFunctionsModule(resolve, reject);
            };
            functionsScript.onerror = () => reject(new Error('Erreur lors du chargement de Firebase Functions'));
            document.head.appendChild(functionsScript);
          }
        }

        function waitForFirebase() {
          let attempts = 0;
          const checkFirebase = setInterval(() => {
            attempts++;
            if (typeof firebase !== 'undefined') {
              clearInterval(checkFirebase);
              if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
              }
              loadFunctionsScript();
            } else if (attempts > 50) {
              clearInterval(checkFirebase);
              reject(new Error('Timeout: Firebase n\'a pas pu être chargé'));
            }
          }, 100);
        }

        function loadFunctionsModule(resolve, reject) {
          let attempts = 0;
          const checkFunctions = setInterval(() => {
            attempts++;
            if (firebase.functions) {
              clearInterval(checkFunctions);
              resolve();
            } else if (attempts > 50) {
              clearInterval(checkFunctions);
              reject(new Error('Firebase Functions n\'a pas pu être initialisé'));
            }
          }, 100);
        }
      });
    }

    // Ouvrir la pop-up
    function openPopup() {
      popup.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      // Réinitialiser Turnstile
      if (turnstileWidget && typeof turnstile !== 'undefined') {
        try {
          turnstile.reset(turnstileWidget);
        } catch (e) {
          console.warn('Impossible de réinitialiser Turnstile:', e);
        }
      }
    }

    // Fermer la pop-up
    function closePopup() {
      popup.classList.add('hidden');
      document.body.style.overflow = '';
      form.reset();
      messageDiv.classList.add('hidden');
      // Réinitialiser Turnstile
      if (turnstileWidget && typeof turnstile !== 'undefined') {
        try {
          turnstile.reset(turnstileWidget);
        } catch (e) {
          console.warn('Impossible de réinitialiser Turnstile:', e);
        }
      }
    }

    // Gérer les boutons qui ouvrent la pop-up
    document.querySelectorAll('[data-open-popup-5jours]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        openPopup();
      });
    });

    // Fermer avec le bouton X
    closeBtn.addEventListener('click', closePopup);

    // Fermer en cliquant en dehors
    popup.addEventListener('click', function(e) {
      if (e.target === popup) {
        closePopup();
      }
    });

    // Fermer avec Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !popup.classList.contains('hidden')) {
        closePopup();
      }
    });

    // Gérer la soumission du formulaire
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('newsletter-email-5jours').value.trim();
      const name = document.getElementById('newsletter-name-5jours').value.trim();

      if (!email || !name) {
        showMessage('Veuillez remplir tous les champs', 'error');
        return;
      }

      // Valider Turnstile (sauf en localhost)
      let turnstileToken = null;
      if (!isLocalhost) {
        const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]');
        if (!turnstileResponse || !turnstileResponse.value) {
          showMessage('Veuillez compléter la vérification anti-bot', 'error');
          return;
        }
        turnstileToken = turnstileResponse.value;
      }

      // Désactiver le bouton
      submitBtn.disabled = true;
      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');

      try {
        // Charger Firebase Functions
        await loadFirebaseFunctions();

        if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
          throw new Error('Firebase n\'est pas initialisé');
        }

        if (!firebase.functions) {
          throw new Error('Firebase Functions n\'est pas disponible');
        }

        // Appeler la fonction Firebase
        const app = firebase.app();
        const functions = app.functions('europe-west1');
        const subscribeTo5Days = functions.httpsCallable('subscribeTo5Days');
        
        const result = await subscribeTo5Days({ 
          email: email, 
          name: name, 
          turnstileToken: turnstileToken,
          isLocalhost: isLocalhost
        });

        if (result.data && result.data.success) {
          // Envoyer l'événement de conversion à Google Analytics
          if (window.dataLayer) {
            window.dataLayer.push({
              event: 'generate_lead_5_jours',
              source: 'newsletter_popup',
              optin_type: '5joursofferts'
            });
            console.log('Opt-in 5 jours conversion tracked');
          }
          
          // Rediriger immédiatement vers le jour 1
          window.location.href = '/cours-en-ligne/5jours/j1/';
        } else {
          throw new Error(result.data?.message || 'Erreur lors de l\'inscription');
        }
      } catch (error) {
        console.error('Erreur lors de l\'inscription:', error);
        let errorMsg = 'Une erreur est survenue. Veuillez réessayer.';
        if (error.message) {
          errorMsg = error.message;
        }
        showMessage(errorMsg, 'error');
        
        // Réactiver le bouton
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    });

    function showMessage(message, type) {
      messageDiv.textContent = message;
      messageDiv.className = `text-sm ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
      messageDiv.classList.remove('hidden');
    }
  });
</script>

<!-- Cloudflare Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

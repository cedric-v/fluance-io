---
layout: base.njk
title: Envoyer les acc√®s 21 jours
description: "Outil d'administration pour envoyer les acc√®s au cours 21 jours."
locale: fr
permalink: /admin/envoyer-acces-21jours/
eleventyExcludeFromCollections: true
robots: noindex, nofollow
---

<section class="max-w-4xl mx-auto px-6 md:px-12 py-16 space-y-8">
  <div class="container bg-white p-8 rounded-lg shadow-md border border-gray-100">
    <h1 class="text-3xl font-semibold text-[#7A1F3D] mb-8">üìß Envoyer les acc√®s au cours 21 jours</h1>
    
    <div id="auth-status" class="p-4 mb-6 rounded-md bg-yellow-50 text-yellow-800 border border-yellow-200">
      <p class="flex items-center gap-2">
        <span class="text-xl">‚ö†Ô∏è</span>
        V√©rification de l'acc√®s administrateur en cours...
      </p>
      <button onclick="signIn()" class="mt-3 px-4 py-2 bg-[#7A1F3D] text-white rounded hover:bg-[#6b1030] transition-colors">Se connecter</button>
    </div>

    <form id="send-form" class="hidden space-y-6">
      <div class="space-y-2">
        <label for="emails" class="block text-sm font-medium text-gray-700">Emails des clients (un par ligne) :</label>
        <textarea id="emails" placeholder="client1@example.com&#10;client2@example.com" required class="w-full min-h-[150px] p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-fluance focus:border-transparent"></textarea>
        <p class="text-xs text-gray-500">Entrez un email par ligne</p>
      </div>

      <div class="space-y-2">
        <label for="expiration-days" class="block text-sm font-medium text-gray-700">Dur√©e de validit√© (jours) :</label>
        <input type="number" id="expiration-days" value="365" min="1" max="3650" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-fluance focus:border-transparent">
        <p class="text-xs text-gray-500">Dur√©e pendant laquelle le lien de cr√©ation de compte reste valide (d√©faut: 365 jours)</p>
      </div>

      <div class="flex gap-4">
        <button type="submit" id="send-button" class="btn-primary !text-[#7A1F3D] bg-[#E6B84A] hover:bg-[#E8C15A] px-6 py-3 rounded-md font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          Envoyer les acc√®s
        </button>
        <button type="button" onclick="signOut()" class="px-6 py-3 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
          Se d√©connecter
        </button>
      </div>
    </form>

    <div id="status-container" class="mt-8 space-y-4">
      <div id="status" class="hidden p-4 rounded-md"></div>
      <div id="results" class="space-y-2"></div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', async function() {
    // La config Firebase est inject√©e via window.FLUANCE_FIREBASE_CONFIG dans base.njk
    const firebaseConfig = window.FLUANCE_FIREBASE_CONFIG;
    
    if (!firebaseConfig || !firebaseConfig.apiKey) {
      console.error('Configuration Firebase manquante !');
      return;
    }

    // Fonction pour charger les modules Firebase n√©cessaires
    async function initAdminAuth() {
      if (typeof firebase === 'undefined') {
        // Attendre que firebase-app-compat.js soit charg√© via base.njk ou le charger ici
        // Pour √™tre s√ªr, on utilise une approche robuste comme dans newsletter-popup.njk
        await loadFirebaseScripts();
      }
      
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      
      const auth = firebase.auth();
      const functions = firebase.functions('europe-west1');

      // V√©rifier l'√©tat d'authentification
      auth.onAuthStateChanged((user) => {
        const authStatus = document.getElementById('auth-status');
        const sendForm = document.getElementById('send-form');
        
        if (user) {
          user.getIdTokenResult().then((tokenResult) => {
            if (tokenResult.claims.admin) {
              authStatus.className = 'p-4 mb-6 rounded-md bg-green-50 text-green-800 border border-green-200';
              authStatus.innerHTML = '‚úÖ Connect√© en tant qu\'admin (' + user.email + ')';
              sendForm.classList.remove('hidden');
            } else {
              authStatus.className = 'p-4 mb-6 rounded-md bg-red-50 text-red-800 border border-red-200';
              authStatus.innerHTML = '‚ùå Votre compte (' + user.email + ') n\'a pas les permissions admin. Contactez l\'administrateur.';
              sendForm.classList.add('hidden');
            }
          });
        } else {
          authStatus.className = 'p-4 mb-6 rounded-md bg-yellow-50 text-yellow-800 border border-yellow-200';
          authStatus.innerHTML = '<p class="mb-3">‚ö†Ô∏è Vous devez √™tre connect√© avec un compte admin pour acc√©der √† cet outil.</p><button onclick="signIn()" class="px-4 py-2 bg-[#7A1F3D] text-white rounded hover:bg-[#6b1030]">Se connecter</button>';
          sendForm.classList.add('hidden');
        }
      });

      // G√©rer la soumission du formulaire
      document.getElementById('send-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const emailsText = document.getElementById('emails').value.trim();
        const expirationDays = parseInt(document.getElementById('expiration-days').value, 10);
        
        const emails = emailsText.split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .filter(email => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email));

        if (emails.length === 0) {
          showStatus('error', 'Aucun email valide trouv√©');
          return;
        }

        const sendButton = document.getElementById('send-button');
        sendButton.disabled = true;
        sendButton.textContent = 'Envoi en cours...';
        
        document.getElementById('results').innerHTML = '';
        showStatus('info', 'Envoi des acc√®s √† ' + emails.length + ' client(s)...');

        const createUserToken = functions.httpsCallable('createUserToken');
        let successCount = 0;
        let failCount = 0;

        for (const email of emails) {
          try {
            const result = await createUserToken({
              email: email,
              product: '21jours',
              expirationDays: expirationDays
            });
            successCount++;
            addResult(email, true, 'Email envoy√© avec succ√®s');
          } catch (error) {
            console.error('Erreur pour', email, ':', error);
            failCount++;
            addResult(email, false, 'Erreur : ' + (error.message || 'Inconnue'));
          }
        }

        sendButton.disabled = false;
        sendButton.textContent = 'Envoyer les acc√®s';

        if (successCount > 0 && failCount === 0) {
          showStatus('success', '‚úÖ ' + successCount + ' email(s) envoy√©(s) avec succ√®s');
        } else {
          showStatus('info', '‚úÖ ' + successCount + ' succ√®s, ‚ùå ' + failCount + ' erreur(s)');
        }
      });
    }

    async function loadFirebaseScripts() {
      const scripts = [
        'https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js',
        'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js',
        'https://www.gstatic.com/firebasejs/12.8.0/firebase-functions-compat.js'
      ];
      
      for (const src of scripts) {
        if (!document.querySelector(`script[src="${src}"]`)) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
      }
    }

    // Exposer signIn et signOut globalement
    window.signIn = function() {
      const email = prompt('Email admin :');
      if (!email) return;
      
      firebase.auth().sendSignInLinkToEmail(email, {
        url: window.location.href,
        handleCodeInApp: true,
      }).then(() => {
        alert('Un lien de connexion a √©t√© envoy√© √† ' + email + '.');
        window.localStorage.setItem('emailForSignIn', email);
      }).catch(error => {
        alert('Erreur : ' + error.message);
      });
    };

    window.signOut = function() {
      firebase.auth().signOut().then(() => {
        alert('D√©connect√©');
      });
    };

    function showStatus(type, message) {
      const statusDiv = document.getElementById('status');
      statusDiv.classList.remove('hidden', 'bg-red-50', 'text-red-800', 'bg-green-50', 'text-green-800', 'bg-blue-50', 'text-blue-800');
      
      if (type === 'error') {
        statusDiv.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
      } else if (type === 'success') {
        statusDiv.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200');
      } else {
        statusDiv.classList.add('bg-blue-50', 'text-blue-800', 'border', 'border-blue-200');
      }
      
      statusDiv.textContent = message;
      statusDiv.classList.remove('hidden');
    }

    function addResult(email, success, message) {
      const resultsDiv = document.getElementById('results');
      const item = document.createElement('div');
      item.className = 'p-3 text-sm rounded border ' + (success ? 'bg-green-50 border-green-100 text-green-700' : 'bg-red-50 border-red-100 text-red-700');
      item.innerHTML = '<strong>' + email + '</strong>: ' + message;
      resultsDiv.appendChild(item);
    }

    // G√©rer le retour du mail de connexion
    await initAdminAuth();
    const auth = firebase.auth();
    if (auth.isSignInWithEmailLink(window.location.href)) {
      let email = window.localStorage.getItem('emailForSignIn');
      if (!email) email = prompt('Veuillez entrer votre email pour confirmer la connexion :');
      if (email) {
        auth.signInWithEmailLink(email, window.location.href)
          .then(() => {
            window.localStorage.removeItem('emailForSignIn');
            window.history.replaceState({}, document.title, window.location.pathname);
          })
          .catch(error => alert('Erreur : ' + error.message));
      }
    }
  });
</script>

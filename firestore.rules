rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Règles pour les tokens d'inscription
    match /registrationTokens/{tokenId} {
      // Seuls les utilisateurs authentifiés peuvent lire leur propre token
      // Les tokens sont vérifiés côté serveur (Firebase Functions)
      allow read: if false; // Les tokens ne doivent jamais être lus côté client
      allow write: if false; // Seules les Firebase Functions peuvent écrire
    }

    // Règles pour les utilisateurs
    match /users/{userId} {
      // Un utilisateur peut lire et mettre à jour son propre document
      allow read, update: if request.auth != null && request.auth.uid == userId;
      // Les Firebase Functions peuvent créer et mettre à jour tous les documents
      allow create, update: if false; // Géré par les Functions
    }

    // Règles pour le contenu protégé (stocké dans Firestore)
    match /protectedContent/{contentId} {
      // Les utilisateurs authentifiés peuvent lire le contenu
      // La vérification que le produit correspond se fait côté client (dans firebase-auth.js)
      allow read: if request.auth != null;
      // Seules les Firebase Functions peuvent écrire
      allow write: if false;
    }

    // Règles pour les commentaires
    // Structure: comments/{pageId}/messages/{messageId}
    match /comments/{pageId} {
      // Permettre la lecture des pages de commentaires
      allow read: if true;
      
      // Règles pour les messages (sous-collection)
      match /messages/{messageId} {
        // Lecture publique des commentaires
        allow read: if true;
        // Écriture autorisée sans authentification (commentaires publics avec nom)
        // Les commentaires sont modérés par validation du contenu côté client
        allow create: if request.resource.data.keys().hasAll(['name', 'text', 'timestamp'])
                      && request.resource.data.name is string
                      && request.resource.data.text is string
                      && request.resource.data.name.size() > 0
                      && request.resource.data.text.size() > 0;
        // Pas de modification ni suppression (commentaires immuables)
        allow update, delete: if false;
      }
    }

    // Toutes les autres collections sont refusées par défaut
    match /{document=**} {
      allow read, write: if false;
    }
  }
}




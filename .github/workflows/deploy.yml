name: Deploy site to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        env:
          ELEVENTY_ENV: prod
        run: npm run build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  validate:
    needs: build
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        env:
          ELEVENTY_ENV: prod
        run: npm run build

      - name: Install validation tools
        run: |
          npm install -g lighthouse@latest w3c-html-validator@latest

      - name: Start local server
        run: |
          cd _site
          npx -y http-server -p 8080 --silent &
          echo $! > /tmp/http-server.pid
          sleep 5
          curl -f http://localhost:8080/ || exit 1

      - name: Run Lighthouse audit
        run: |
          mkdir -p reports
          lighthouse http://localhost:8080/ --output=html --output-path=./reports/lighthouse-home.html --chrome-flags="--headless --no-sandbox"
          lighthouse http://localhost:8080/fr/ --output=html --output-path=./reports/lighthouse-fr.html --chrome-flags="--headless --no-sandbox"
          lighthouse http://localhost:8080/en/ --output=html --output-path=./reports/lighthouse-en.html --chrome-flags="--headless --no-sandbox" || true
          
          # Generate JSON reports for summary
          lighthouse http://localhost:8080/ --output=json --output-path=./reports/lighthouse-home.json --chrome-flags="--headless --no-sandbox"
          lighthouse http://localhost:8080/fr/ --output=json --output-path=./reports/lighthouse-fr.json --chrome-flags="--headless --no-sandbox"

      - name: Validate HTML with W3C
        run: |
          mkdir -p reports/w3c
          echo "ðŸ” Recherche des fichiers HTML..."
          HTML_FILES=$(find _site -name "*.html" -type f | head -10)
          echo "ðŸ“„ Fichiers trouvÃ©s:"
          echo "$HTML_FILES"
          
          if [ -z "$HTML_FILES" ]; then
            echo "âš ï¸ Aucun fichier HTML trouvÃ© dans _site/"
            echo "Aucun fichier HTML trouvÃ©" > reports/w3c/README.txt
            exit 0
          fi
          
          BASE_URL="http://localhost:8080"
          COUNT=0
          
          echo "$HTML_FILES" | while read file; do
            if [ -f "$file" ]; then
              # Convertir le chemin du fichier en URL relative
              REL_PATH=$(echo "$file" | sed 's|^_site/||' | sed 's|^/||')
              if [ "$REL_PATH" = "index.html" ]; then
                URL="${BASE_URL}/"
              else
                URL="${BASE_URL}/${REL_PATH}"
              fi
              
              # CrÃ©er un nom de fichier pour le rapport
              REPORT_NAME=$(echo "$REL_PATH" | sed 's|/|_|g' | sed 's|\.html$||' | sed 's|^_||')
              if [ -z "$REPORT_NAME" ] || [ "$REPORT_NAME" = "index" ]; then
                REPORT_NAME="index"
              fi
              
              echo ""
              echo "âœ… Validation de: $file"
              echo "   URL: $URL"
              echo "   Rapport: reports/w3c/${REPORT_NAME}"
              
              # Validation via URL (plus fiable)
              if w3c-html-validator "$URL" --format=html --output=./reports/w3c/"${REPORT_NAME}.html" 2>&1; then
                echo "  âœ“ Rapport HTML crÃ©Ã©: reports/w3c/${REPORT_NAME}.html"
                COUNT=$((COUNT + 1))
              else
                echo "  âš ï¸ Tentative avec le fichier local..."
                # Fallback: validation via fichier local
                if w3c-html-validator --file "$file" --format=html --output=./reports/w3c/"${REPORT_NAME}.html" 2>&1; then
                  echo "  âœ“ Rapport HTML crÃ©Ã© (via fichier): reports/w3c/${REPORT_NAME}.html"
                  COUNT=$((COUNT + 1))
                else
                  echo "  âœ— Erreur lors de la validation"
                  echo "<html><body><h1>Erreur lors de la validation W3C</h1><p>Fichier: $file</p><p>URL: $URL</p></body></html>" > ./reports/w3c/"${REPORT_NAME}.html"
                fi
              fi
              
              # Validation JSON
              if w3c-html-validator "$URL" --format=json --output=./reports/w3c/"${REPORT_NAME}.json" 2>&1; then
                echo "  âœ“ Rapport JSON crÃ©Ã©: reports/w3c/${REPORT_NAME}.json"
              else
                # Fallback: validation via fichier local
                if w3c-html-validator --file "$file" --format=json --output=./reports/w3c/"${REPORT_NAME}.json" 2>&1; then
                  echo "  âœ“ Rapport JSON crÃ©Ã© (via fichier): reports/w3c/${REPORT_NAME}.json"
                else
                  echo "  âœ— Erreur lors de la crÃ©ation du rapport JSON"
                  echo '{"errors": [], "warnings": [], "info": "Erreur lors de la validation"}' > ./reports/w3c/"${REPORT_NAME}.json"
                fi
              fi
            fi
          done
          
          echo ""
          echo "ðŸ“Š RÃ©sumÃ© des rapports W3C gÃ©nÃ©rÃ©s:"
          ls -lah reports/w3c/ || echo "âš ï¸ Le dossier reports/w3c est vide"
          
          # CrÃ©er un fichier README si le dossier est vide
          if [ ! "$(ls -A reports/w3c 2>/dev/null)" ]; then
            echo "âš ï¸ Aucun rapport W3C gÃ©nÃ©rÃ©. CrÃ©ation d'un fichier README."
            echo "Aucun rapport W3C n'a pu Ãªtre gÃ©nÃ©rÃ© lors de cette exÃ©cution." > reports/w3c/README.txt
          fi

      - name: Generate validation summary
        run: |
          cat > reports/summary.md << 'EOF'
          # Rapport de validation du site
          
          ## Google Lighthouse
          
          Les rapports Lighthouse sont disponibles dans les fichiers HTML :
          - `lighthouse-home.html` - Page d'accueil
          - `lighthouse-fr.html` - Page franÃ§aise
          - `lighthouse-en.html` - Page anglaise (si disponible)
          
          ## Validateur W3C
          
          Les rapports de validation HTML sont disponibles dans le dossier `w3c/`.
          
          ## Comment consulter les rapports
          
          1. Allez dans l'onglet "Actions" de votre repository GitHub
          2. Cliquez sur le workflow qui vient de s'exÃ©cuter
          3. Cliquez sur le job "validate"
          4. Dans la section "Artifacts", tÃ©lÃ©chargez le fichier "validation-reports"
          5. DÃ©compressez le fichier pour accÃ©der aux rapports HTML
          
          EOF
          cat reports/summary.md

      - name: Stop local server
        if: always()
        run: |
          if [ -f /tmp/http-server.pid ]; then
            kill $(cat /tmp/http-server.pid) || true
          fi

      - name: Upload validation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: reports/
          retention-days: 30
          if-no-files-found: warn
      
      - name: List uploaded artifacts
        if: always()
        run: |
          echo "âœ… Les rapports ont Ã©tÃ© uploadÃ©s dans l'artifact 'validation-reports'"
          echo "ðŸ“¥ Pour tÃ©lÃ©charger :"
          echo "   1. Faites dÃ©filer jusqu'en bas de cette page"
          echo "   2. Cherchez la section 'Artifacts'"
          echo "   3. Cliquez sur 'validation-reports' pour tÃ©lÃ©charger le ZIP"
          echo ""
          echo "ðŸ“Š Contenu de l'artifact :"
          ls -lah reports/ || echo "Dossier reports non trouvÃ©"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

name: Deploy site to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        env:
          ELEVENTY_ENV: prod
        run: npm run build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  validate:
    needs: build
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      # URL de production du site (peut √™tre modifi√©e dans les variables du repository)
      PRODUCTION_URL: ${{ vars.PRODUCTION_URL || 'https://fluance.io' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        env:
          ELEVENTY_ENV: prod
        run: npm run build

      - name: Install validation tools
        run: |
          npm install -g lighthouse@latest w3c-html-validator@latest

      - name: Start local server
        run: |
          cd _site
          npx -y http-server -p 8080 --silent &
          echo $! > /tmp/http-server.pid
          sleep 5
          curl -f http://localhost:8080/ || exit 1

      - name: Run Lighthouse audit
        run: |
          mkdir -p reports
          lighthouse http://localhost:8080/ --output=html --output-path=./reports/lighthouse-home.html --chrome-flags="--headless --no-sandbox"
          lighthouse http://localhost:8080/fr/ --output=html --output-path=./reports/lighthouse-fr.html --chrome-flags="--headless --no-sandbox"
          lighthouse http://localhost:8080/en/ --output=html --output-path=./reports/lighthouse-en.html --chrome-flags="--headless --no-sandbox" || true
          
          # Generate JSON reports for summary
          lighthouse http://localhost:8080/ --output=json --output-path=./reports/lighthouse-home.json --chrome-flags="--headless --no-sandbox"
          lighthouse http://localhost:8080/fr/ --output=json --output-path=./reports/lighthouse-fr.json --chrome-flags="--headless --no-sandbox"

      - name: Validate HTML with W3C
        run: |
          mkdir -p reports/w3c
          echo "üîç Recherche des fichiers HTML..."
          HTML_FILES=$(find _site -name "*.html" -type f | head -10)
          echo "üìÑ Fichiers trouv√©s:"
          echo "$HTML_FILES"
          
          if [ -z "$HTML_FILES" ]; then
            echo "‚ö†Ô∏è Aucun fichier HTML trouv√© dans _site/"
            echo "Aucun fichier HTML trouv√©" > reports/w3c/README.txt
            exit 0
          fi
          
          while read file; do
            if [ -f "$file" ]; then
              # Cr√©er un nom de fichier pour le rapport bas√© sur le chemin relatif
              REL_PATH=$(echo "$file" | sed 's|^_site/||' | sed 's|^/||')
              REPORT_NAME=$(echo "$REL_PATH" | sed 's|/|_|g' | sed 's|\.html$||' | sed 's|^_||' | sed 's|_index$||')
              if [ -z "$REPORT_NAME" ]; then
                REPORT_NAME="index"
              fi
              
              echo ""
              echo "‚úÖ Validation de: $file"
              echo "   Rapport: reports/w3c/${REPORT_NAME}"
              
              # Utiliser directement l'API W3C Nu Validator (plus fiable)
              # Construire l'URL de production pour remplacer localhost dans les rapports
              # L'URL de production est d√©finie via la variable d'environnement PRODUCTION_URL
              PROD_URL="${PRODUCTION_URL:-https://fluance.io}"
              if [ "$REL_PATH" = "index.html" ]; then
                DOC_URL="${PROD_URL}/"
              elif echo "$REL_PATH" | grep -q "index.html$"; then
                # Cas comme "fr/index.html" -> "https://fluance.io/fr/"
                DIR_PATH=$(dirname "$REL_PATH")
                DOC_URL="${PROD_URL}/${DIR_PATH}/"
              else
                DIR_PATH=$(dirname "$REL_PATH")
                DOC_URL="${PROD_URL}/${DIR_PATH}/"
              fi
              
              # Format HTML
              API_URL_HTML="https://validator.w3.org/nu/?out=html"
              HTTP_CODE=$(curl -s -o ./reports/w3c/"${REPORT_NAME}.html" -w "%{http_code}" -X POST \
                -H "Content-Type: text/html; charset=utf-8" \
                --data-binary "@$file" \
                "$API_URL_HTML" 2>&1)
              
              if [ "$HTTP_CODE" = "200" ] && [ -s ./reports/w3c/"${REPORT_NAME}.html" ]; then
                # Post-traiter le rapport pour remplacer toutes les r√©f√©rences √† localhost
                # Utiliser perl pour la compatibilit√© cross-platform (Linux et macOS)
                perl -i -pe "s|http://localhost:8080[^\s\"']*|${DOC_URL}|g" ./reports/w3c/"${REPORT_NAME}.html" 2>/dev/null || \
                sed -i.bak "s|http://localhost:8080[^[:space:]\"']*|${DOC_URL}|g" ./reports/w3c/"${REPORT_NAME}.html" 2>/dev/null && rm -f ./reports/w3c/"${REPORT_NAME}.html.bak" || true
                echo "  ‚úì Rapport HTML cr√©√©: reports/w3c/${REPORT_NAME}.html (URLs mises √† jour)"
              else
                echo "  ‚ö†Ô∏è Erreur HTTP $HTTP_CODE lors de la validation HTML"
                # Afficher les premi√®res lignes du fichier pour debug
                if [ -s ./reports/w3c/"${REPORT_NAME}.html" ]; then
                  echo "  Contenu du rapport (premi√®res lignes):"
                  head -3 ./reports/w3c/"${REPORT_NAME}.html"
                fi
              fi
              
              # Format JSON
              API_URL_JSON="https://validator.w3.org/nu/?out=json"
              HTTP_CODE_JSON=$(curl -s -o ./reports/w3c/"${REPORT_NAME}.json" -w "%{http_code}" -X POST \
                -H "Content-Type: text/html; charset=utf-8" \
                --data-binary "@$file" \
                "$API_URL_JSON" 2>&1)
              
              if [ "$HTTP_CODE_JSON" = "200" ] && [ -s ./reports/w3c/"${REPORT_NAME}.json" ]; then
                # Post-traiter le JSON pour remplacer toutes les r√©f√©rences √† localhost
                perl -i -pe "s|http://localhost:8080[^\s\"']*|${DOC_URL}|g" ./reports/w3c/"${REPORT_NAME}.json" 2>/dev/null || \
                sed -i.bak "s|http://localhost:8080[^[:space:]\"']*|${DOC_URL}|g" ./reports/w3c/"${REPORT_NAME}.json" 2>/dev/null && rm -f ./reports/w3c/"${REPORT_NAME}.json.bak" || true
                echo "  ‚úì Rapport JSON cr√©√©: reports/w3c/${REPORT_NAME}.json (URLs mises √† jour)"
              else
                echo "  ‚ö†Ô∏è Erreur HTTP $HTTP_CODE_JSON lors de la validation JSON"
              fi
            fi
          done <<< "$HTML_FILES"
          
          echo ""
          echo "üìä R√©sum√© des rapports W3C g√©n√©r√©s:"
          ls -lah reports/w3c/ || echo "‚ö†Ô∏è Le dossier reports/w3c est vide"
          
          # Cr√©er un fichier README si le dossier est vide
          if [ ! "$(ls -A reports/w3c 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è Aucun rapport W3C g√©n√©r√©. Cr√©ation d'un fichier README."
            echo "Aucun rapport W3C n'a pu √™tre g√©n√©r√© lors de cette ex√©cution." > reports/w3c/README.txt
          fi

      - name: Generate validation summary
        run: |
          cat > reports/summary.md << 'EOF'
          # Rapport de validation du site
          
          ## Google Lighthouse
          
          Les rapports Lighthouse sont disponibles dans les fichiers HTML :
          - `lighthouse-home.html` - Page d'accueil
          - `lighthouse-fr.html` - Page fran√ßaise
          - `lighthouse-en.html` - Page anglaise (si disponible)
          
          ## Validateur W3C
          
          Les rapports de validation HTML sont disponibles dans le dossier `w3c/`.
          
          ## Comment consulter les rapports
          
          1. Allez dans l'onglet "Actions" de votre repository GitHub
          2. Cliquez sur le workflow qui vient de s'ex√©cuter
          3. Cliquez sur le job "validate"
          4. Dans la section "Artifacts", t√©l√©chargez le fichier "validation-reports"
          5. D√©compressez le fichier pour acc√©der aux rapports HTML
          
          EOF
          cat reports/summary.md

      - name: Stop local server
        if: always()
        run: |
          if [ -f /tmp/http-server.pid ]; then
            kill $(cat /tmp/http-server.pid) || true
          fi

      - name: Upload validation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: reports/
          retention-days: 30
          if-no-files-found: warn
      
      - name: List uploaded artifacts
        if: always()
        run: |
          echo "‚úÖ Les rapports ont √©t√© upload√©s dans l'artifact 'validation-reports'"
          echo "üì• Pour t√©l√©charger :"
          echo "   1. Faites d√©filer jusqu'en bas de cette page"
          echo "   2. Cherchez la section 'Artifacts'"
          echo "   3. Cliquez sur 'validation-reports' pour t√©l√©charger le ZIP"
          echo ""
          echo "üìä Contenu de l'artifact :"
          ls -lah reports/ || echo "Dossier reports non trouv√©"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
